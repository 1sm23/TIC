## 功能简介

腾讯云互动课堂本地录制服务为您提供了在上课过程中，在本地电脑将应用整个窗口或者部分窗口区域录制为视频的能力，同时可选择将录制视频上传到腾讯云平台，课程结束后满足老师分享视频和方便学生回放查看的业务场景。

## 开发环境要求
Windows 7 及以上版本 Windows 操作系统
Microsoft Visual Studio 2015 及以上版本，推荐使用 Microsoft Visual Studio 2015
Windows SDK 8.0 及以上版本，推荐使用 Windows SDK 8.1


## 本地录制服务概要
![](https://main.qcloudimg.com/raw/c72eaef628f6e5bab646a7f8a617ccf9.png)

说明：
1. 业务客户端与本地录制服务之间通信方式是http;
2. 在录制过程中，录制视频会按时长分片生成本地文件，然后上传服务进行分片视频并行上传后台； 
3. 在客户端提供本地录制Paas接口，方便用户接入。(参考本地录制TIC SDK接口)

## 如何使用本地录制
![](https://main.qcloudimg.com/raw/dbe606098f2eb8f5935b42fbe8b0d014.png)



### 准备 UserId 和 UserSig

初始化本地录制服务时，需要对启用录制服务的用户身份进行鉴定，确认其是否开通本地录制服务，因此需要您提供`UserId`以及`UserSig`，生成`UserId`和`UserSig`请参考 [如何计算 UserSig](https://cloud.tencent.com/document/product/647/17275)。


### 开始与结束录制

在需要进行录制时，例如老师学生都已经准备好开始上课，您可以使用**开始录制**接口开始本地录制。

在课堂结束或者需要停止录制的时候，您可以使用**停止录制**接口停止当前录制。

>在停止录制后，录制分片文件上传到腾讯云还需要点时间，这个时间长度受网络状态影响；

### 暂停与恢复录制

在上课过程中存在中途休息时间，如果不希望录制此段视频，可以使用**暂停录制**接口和**恢复录制**接口实现。

录制任务的状态转换图如下所示：
![](https://main.qcloudimg.com/raw/70ebfdd22ae6b033ad49237b947bb990.png)

### 录制回调和录制结果查询
在录制完成后，录制服务后台会给业务服务器回调录制结果； 

如果您需要查询录制结果，可通过查询接口向录制后台获取录制列表;


## 具体使用方式
### 本地录制服务示例(C++方式)
本地录制以独立的进程方式存在，提供录制服务。此服务的启动方式可参考如下代码.
``` c
/**
* @brief 启动本地录制服务
* @param path 本地录制服务程序(TXCloudRecord.exe)所在位置
* @return 是否启动成功
*/
bool TICLocalRecorderImpl::startService(const std::string& path) {
	BOOL ret = FALSE;
	std::string cmd = "";

	SHELLEXECUTEINFOA sei = { 0 };
	sei.cbSize = sizeof(SHELLEXECUTEINFOA);
	sei.fMask = SEE_MASK_NOCLOSEPROCESS;
	sei.hwnd = NULL;
	sei.lpVerb = "open";
	sei.lpFile = path.c_str();
	sei.lpParameters = cmd.c_str();
	sei.lpDirectory = NULL;
	sei.nShow = SW_HIDE;
	sei.hInstApp = NULL;
	sei.lpIDList = NULL;
	sei.lpClass = NULL;
	sei.hkeyClass = NULL;
	sei.dwHotKey = NULL;
	sei.hIcon = NULL;
	sei.hProcess = NULL;

	ret = ::ShellExecuteExA(&sei);

	return ret;
}

//初始化
int TICLocalRecorderImpl::init(const TEduRecordAuthParam& authParam, TICCallback callback) {

    Json::Value value;
    value["SdkAppId"] = authParam.appId;
    value["UserId"] = authParam.userId;
    value["UserSig"] = authParam.userSig;

    Json::FastWriter writer;
    std::string msg = writer.write(value);

    sendCmd("Init", msg, callback);
    return 0;
}

//开始录制
int TICLocalRecorderImpl::startLocalRecord(const TEduRecordParam& para, const char * szRecordPath, TICCallback callback) {
    Json::Value value;
    value["AppProc"] = para.AppProc;
    value["Wnd"] = para.Wnd;
    value["x"] = para.x;
    value["y"] = para.y;
    value["Width"] = para.width;
    value["Height"] = para.Height;
    value["VideoFps"] = para.videoFps;
    value["VideoBps"] = para.videoBps;
    value["EnableAudio"] = para.enableAudio;
    value["DstPath"] = szRecordPath;
    value["ClassId"] = para.classId;

    Json::FastWriter writer;
    std::string msg = writer.write(value);
    sendCmd("StartRecord", msg, callback);

    return 0;
}
//停止录制
int TICLocalRecorderImpl::stopLocalRecord(TICCallback callback) {
    sendCmd("StopRecord", std::string(), callback);
    return 0;
}
//按HTTP请求，发送命令字
void TICLocalRecorderImpl::sendCmd(const std::string& cmd, const std::string& content, const TICCallback callback) {
    sendRequest(HttpClient::a2w(URL + cmd), content, callback);
}
//HTPP请求
void TICLocalRecorderImpl::sendRequest(const std::wstring& url, const std::string& reqBody, const TICCallback callback) {
    if (!url.empty()) {
        http.asynPost(url, reqBody, [=](int code, const HttpHeaders& rspHeaders, const std::string& rspBuf) {
            //处理回包
        }
        );
    }
}


```

### 本地录制服务示例(JS方式)
#### 首先在Windows上向注册表写入浏览器协议
此步骤可以通过安装包安装时写入或者脚本方式写入；
```json
//打入安装包，在安装时写入注册表,使用场景多在安装发布时
!macro customInstall
  DetailPrint "注册浏览器协议"
  WriteRegStr HKCR "tc-record" "" "Client Record"
  WriteRegStr HKCR "tc-record" "URL Protocol" ""
  WriteRegStr HKCR "tc-record\DefaultIcon" "" "$INSTDIR\${APP_EXECUTABLE_FILENAME}"
  WriteRegStr HKCR "tc-record\shell" "" ""
  WriteRegStr HKCR "tc-record\shell\open" "" ""
  WriteRegStr HKCR "tc-record\shell\open\command" "" "$INSTDIR\${APP_EXECUTABLE_FILENAME} %1"
  ReadRegStr $0 HKCR "tc-record\shell\open\command" ""
!macroend


//通过脚本写入注册表，使用场景多在开发测试时，将下面的内容写入文本中，后缀名改为reg，双击即可.
Windows Registry Editor Version 5.00

[HKEY_CLASSES_ROOT\tc-record]
"URL Protocol"=""

[HKEY_CLASSES_ROOT\tc-record\shell]

[HKEY_CLASSES_ROOT\tc-record\shell\open]

[HKEY_CLASSES_ROOT\tc-record\shell\open\command]
@="C:\\Record\\TXCloudRecord.exe %1"  //本地录制服务可执行文件的位置

```

#### web中拉起本地录制服务
  需要在web页中加入链接，用户点击时则会提示是否启用本地录制。
```json
<a href="tc-record://test">拉起录制</a>
```
![](https://main.qcloudimg.com/raw/89d3bfad2f1b096d4339d58b20dc7e5c.png)

#### 通过HTTP协议与本地录制服务进行交互
```java
//初始化录制
init() {
    var value = {};

    value.SdkAppId = this.sdkAppId; //
    value.UserId = this.account;
    value.UserSig = this.UserSig;

    this.sendCmd("Init", value, res => {
        if (res.code == 0) {
            var obj = JSON.parse(res.desc);
            //解析回包结果
            //console.log('TIC', "Init Local Record Succ." + res.code);
        } 
        else {
            console.log("TIC Init Local Record Failed. " + res.code);
        }
    });
}
//开始录制
start() {
    var value = {};
    value.AppProc = "chrome.exe";
    //  value.x = 100;
    //  value.y = 100;
    //  value.Width = 600;
    //  value.Height = 400;
    // value.DstPath = "E:\\test\\test-02.flv"; //录制后本地文件地址
    value.ClassId = this.Classid; //更换你自已的课堂号

    this.sendCmd("StartRecord", value, res => {
        //解析回包结果
    });
}
//停止录制
stop() {
    var value = {};
    this.sendCmd("StopRecord", value, res => {
    //处理回调
    });
},

sendCmd(cmd, obj, callback) {
    this.sendReques("http://127.0.0.1:37604/localrecord/v1/" + cmd, obj, callback);
},
//发送HTTP请求
sendReques(url, obj, callback) {
    var httpRequest = new XMLHttpRequest();//第一步：创建需要的对象
    httpRequest.open('POST', url, true); //第二步：打开连接/***发送json格式文件必须设置请求头  */
    httpRequest.setRequestHeader("Content-type","application/json");//设置请求头 注：post方式必须设置请求头（在建立连接后设置请求头）var obj = { name: 'zhansgan', age: 18 };
    httpRequest.send(JSON.stringify(obj));//发送请求 将json写入send中
    /**
    * 获取数据后的处理程序
    */
    httpRequest.onreadystatechange = function () {//请求后的回调接口，可将请求成功后要执行的程序写在其中
        if (httpRequest.readyState == 4 && httpRequest.status == 200) {//验证请求是否发送成功
            var json = httpRequest.responseText;//获取到服务端返回的数据
            var result = {};
            result.code = 0;
            result.desc = json;
            if (callback !== null)
            callback(result);
        }
        else {
            var result = {};
            result.code = -1;
            result.desc = "error";
            if (callback !== null)
            callback(result);
        }
    };
},

```

## 本地录制服务提供的接口
### 客户端接口
1. 通过HTTP协议方式，Content-Type: application/json，POST请求;
2. 接口请求地址：http://127.0.0.1:37604/localrecord/v1/CMD,其中CMD表示具体的命令字，如(StartRecord);
3. 不要在业务主线程中进行Http请求，会阻塞业务;


#### 初始化和鉴权
命令字：**Init**
参数：
| 参数 | 类型 | 含义 |备注 |
|-----|-----|-----|-----|
| SdkAppId | int | appid |必填 |
| UserId | int | appid |必填 |
| UserSig | string | 用户Key |必填 |

``` json
//Content内容
{"SdkAppId":1400162216, "UserId":"seven", "UserSig":"xxxxxxxx"}
``` 

#### 开始录制
命令字：**StartRecord**
参数：
| 参数 | 类型 | 含义 |备注 |
|-----|-----|-----|-----|
| AppProc | string | 被录制程序进程名，如QQMusic.exe |选填，如果用户业务进程只一个，如果有多进程，请填wnd |
| Wnd | int |  被录制的程序窗口id |选填，在AppProc和Wnd中必须填一个参数 |
| DstPath | string | 录制文件的路径 |必填，暂时本地录制的视频只支持flv |
| x | int | 录制区域顶点x位置 | 选填，默认为0|
| y | int | 录制区域顶点y位置 |选填，默认为0 |
| Width | int | 录制区域宽度 |选填，默认为0, 表示整个窗口的宽度 |
| Height | int | 录制区域高度 |选填，默认为0，表示整个窗口的高度 |
| VideoFps | int | 视频采集帧率 |选填，默认 15 |
| EnableAudio | bool | 开启音频 |选填，默认值true |
| EnableUpload | bool | 开启将视频上传腾讯云，方便后续分享和回放 |选填，默认值true|
| SliceTime | int | 视频分片时长(单位:秒)) |选填，默认值 5 * 60, 表示5分钟 |
| ClassId | int | 课堂号 | 必填，用于录制资源和课堂关联 |

``` json
//示例
{"AppProc":"QQMusic.exe", "Wnd": 0, "DstPath":"E:\\test.flv", "x":0, "y":10, "Width":100,"Height": 100}
``` 


#### 停止录制
命令字：**StopRecord**
参数：无

#### 暂停录制
命令字：**PauseRecord**
参数：无

#### 暂停录制
命令字：**ResumeRecord**
参数：无


#### 获取状态
命令字：**GetState**
参数：无
返回值:

``` json
{
"Response": {
    "Auth": {"UserId": "xxxx","State": "Auth Success"},
    "Record": {"State": "Recording","Duration": 30},
    "Upload": [{"Id": "123_002_00001","State": "wait", "Total": 200, "IsCurrentRecoding":true}]
    }
}
```
认证状态
| 参数 | 类型 |描述 | 备注 |
|-----|-----|-----|-----|
| UserId | string |用户名 |录制用户的Id|
| State | string |状态 |Not Authentication, Authoring, Auth Failed, Auth Success|

录制状态
| 参数 | 类型 |描述 | 备注 |
|-----|------|----|-----| 
| State | string |当时录制所处状态 |Idle, Recording，Paused|
| Duration | int | 录制时长 | 当前录制持续的时长 |

上传状态
| 参数 | 类型 |描述 | 备注 |
|-----|------|----|-----|
| Id | string |录制任务的标识符 ||
| State | string |当前上传的状态 | wait、uploading、uploaded、upload failed|
| Duration | int | 已完成上传视频的时长 | 因为录制是分片上传，所以上传的进度慢于录制进度 |
| Total | int | 录制视频的总时长 |  |
| IsCurrentRecoding | bool | 是否为当前正在录制的任务 | 表示是否为当前正在录制的任务，可能还有异常恢复的上传队列 |

#### 录制服务退出: (Exit)
请求参数:无


#### 接口返回值说明
**正常返回**
``` json
{
    "Response": {
    }
}
```

**错误返回**
``` json
{
    "Response": {
        "Error": {
            "Code": -10000,
            "Message": "Invalid parameter"
        }
    }
}
```

#### 错误码
| 错误码 | 描述 | 备注 |
|-----|-----|-----|
| -10000 | 参数有误 |  |
| -10001 | 认证失败 |  |
| -10002 | 指定录制文件存放位置有误 |  |
| -10003 | 推流地址有误 |  |
| -10004 | 录制机器没有开DWM |会影响到录制窗口被遮挡|
| -10005 | 录制空间满 |  |

### 后台接口
#### 录制后台回调服务
##### 注册回调
接口方法：POST
Content-Type：application/json
接口 URL：https://yun.tim.qq.com/v4/ilvb_edu/local_record?sdkappid=%d&identifier=%s&usersig=%s&random=123&contenttype=json

content中所带字段，格式如下：
| 参数 | 描述 | 备注 |
|-----|-----|-----|
| Action | 请求注册回调的命令字 |  |
| CallbackUrl | 希望服务器回调的URL |  |

```json
//request
{
    "Action":"RegisteredCallback",
    "CallbackUrl":"http://www.xxxx.com"
}
//response
{
    "Response": {
        "RequestId": "2"
    }
}
```

##### 录制回调内容解析
如果您向录制后台注册了回调，录制结束后将会收到回调数据。参数说明如下：
| 参数 | 描述 | 备注 |
|-----|-----|-----|
| SdkAppId | 录制用户的appid |  |
| RoomId | 录制用户的房间号 |  |
| UserId | 录制用户名 |  |
| TaskId | 此录制的任务标识 |  |
| StartTime | 录制的开始时间 |  |
| SplicTime | 后台对视频进行拼接的时间点 |  |
| VideoOutputType | 录制视频的格式 | 当前为mp4  |
| VideoOutputId | 录制视频在后台的唯一标识 |  |
| VideoOutputUrl | 录制视频地址 |  |
| VideoOutputSize | 录制视频的文件大小 |  |
| VideoOutputDuration | 录制视频的时长 | 单位(ms) |

```json
{
    "SdkAppId":1212,
    "RoomId": 1212,
    "UserId": "eric",
    "TaskId": "1257307760-EditMedia-fbd05676116bb6297f8c5162ec54ef93t0",
    "StartTime": 0,
    "SplicTime": 1574408606,
    "VideoOutputType": "mp4",
    "VideoOutputId": "5285890796076789146",
    "VideoOutputUrl": "http://1257307760.vod2.myqcloud.com/5f5371a5vodgzp1257307760/2d508f205285890796076789146/playlist.f9.mp4",
    "VideoOutputSize": 0,
    "VideoOutputDuration": 0
}
```

#### 从录制后台获取录制列表
##### 接口
- 接口名称：`/localrecord/query`
- 接口方法：`POST`
- Content-Type：`application/json`
- 接口 URL：`https://iclass.api.qcloud.com/paas/v1/localrecord/query?sdkappid=%d&sign=%s&expire_time=%d&random=%d`

| 参数名 | 类型 | 描述 |
| :------ | :--- | :---- |
| sdkappid | int | 腾讯云账号下开通 TRTC 后，会得到一个唯一的项目标识 SDKAppID |
| random | int | 一个随机数，用于区分不同的请求，过滤日志等 |
| expire_time | int64 | 请求签名串过期时间戳 |
| sign | string | API 鉴权字符串 md5(TicKey+expire_time)|

**举例：**
1. 当前UTC时间戳是`1548247717`，以秒为单位。
2. 签名有效时间是120秒，则过期时间戳是`1548247717+120=1548247837`。
3. 如果`tic_key` 是 `DzXpbluRsmo1JkoFxzKMNg5ifrA4GRlU`。
4. 将过期时间拼在tic_key后面<font color=#0000ff>DzXpbluRsmo1JkoFxzKMNg5ifrA4GRlU</font><font color=#ff0000>1548247837</font>
5. sign=md5(<font color=#0000ff>DzXpbluRsmo1JkoFxzKMNg5ifrA4GRlU</font><font color=#ff0000>1548247837</font>)=28374bd8cff400ac4906414780fbe387`。
6. 在请求体中，带上 expire_time 字段，值为`1548247837`。
7. 在请求 url 的参数中，带上`sign=28374bd8cff400ac4906414780fbe387`。

##### 请求参数

| 参数名 | 类型 | 描述 | 是否必填 | 默认值 |
| :------ | :--- | :---- | :--------: | :-----: |
| class_id | int | 课堂 ID | 是 | 0
| user_id | string | 录制用户id | 否 | 0
| task_id | string | 录制任务id，本地录制拼接成功返回给客户端的id | 否 | 0
| Index | int | 分页拉取时，页面起始数据位置 | 是| 0
| size | int | 分页拉取时，页面数据个数 | 是 | 0


##### 响应参数

| 参数名 | 类型 | 描述 | 是否必填 | 默认值 |
| :------ | :--- | :---- | :--------: | :-----: |
| error_code | int | 错误码，0-成功/非0-失败 | 是 | - |
| error_msg | string | 错误信息 | 是 | - |
| finish | bool | 是否拉取完 | 是 | - |
| total | string | 录制文件总数 | 是 | - |
| record_info_list | array | 录制文件列表 | 是 | - |


##### 举例
请求：
```json
{
	"class_id":1212,
	"user_id":"",
	"task_id":"",
	"Index":0,
	"size":2
}
```
响应：
```json
{
    "error_code": 0,
    "error_msg": "",
    "finish": true,
    "total": 1,
    "record_info_list": [
        {
            "RoomId": 1212,
            "UserId": "eric",
            "TaskId": "1257307760-EditMedia-fbd05676116bb6297f8c5162ec54ef93t0",
            "StartTime": 0,
            "SplicTime": 1574408606,
            "VideoOutputType": "mp4",
            "VideoOutputId": "5285890796076789146",
            "VideoOutputUrl": "http://1257307760.vod2.myqcloud.com/5f5371a5vodgzp1257307760/2d508f205285890796076789146/playlist.f9.mp4",
            "VideoOutputSize": 0,
            "VideoOutputDuration": 0
        }
    ]
}
```



## 常见问题
1. **在Win7器上录制视频时，发现被录制的窗口被遮挡;**
原因：因为窗口抗遮挡是能过DWM(Desktop Window Manager)来实现, 如果使用本地录频服务的windows机器没有打开DWM，导致不能抗遮挡.
开启方式：
- 按下“Win+R”组合键呼出运行，在框内输入“services.msc”按下回车键打开“服务”窗口,如图所示：
![](https://main.qcloudimg.com/raw/8185861a279c73fec0e488b90328a46d.png)
- 在服务窗口中找到并双击打开“Desktop Window Manager Session Manager”服务;如图所示：
![](https://main.qcloudimg.com/raw/6e25c9059e48c3894da500c502570e61.png)

- 点击常规选卡，将启动类型修改为“自动”，点击“应用”，然后点击“启动”，最后点击确定即可。如图所示：
- ![](https://main.qcloudimg.com/raw/2370e6858df828a0ae93263f72b46fea.png)

2. **在调用停止录制结之后，通过查询接口，不能马上查到当前录制的视频**
  - 在录制结束后，还需要将录制分片文件上传，虽然上传服务是边录边上传，但最后一个分片生成后还需要一个短暂的上传时间，我们从统计结果来看，一般情况下在2分钟内可以上传完成(依赖于用户的网络状态)。
  - 在上传结束后，录制后台还需要将上传的若干视频分片进行拼接，这个过程需要3-5分钟。(此时间后续可优化)
  所以，基于上面的两个原因，在录制结束后，估计要在5-10分钟，才能查到录制的视结果。可以监听后台回调服务，最快获取到结果。